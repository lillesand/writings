<!DOCTYPE html>
<html>
    <head>
        <script src="signalling/lib/socket.io.js"></script>
        <script src="../lib/webrtc-adapter.js"></script>
    </head>

    <body>
        <video autoplay></video>
        <canvas></canvas>
        <div></div>
    </body>

    <script type="application/javascript">
        var video = document.querySelector('video'),
                canvas = document.querySelector('canvas');

        var peer = new RTCPeerConnection(iceServerConfig(), []);

        var socketUrl = 'http://' + window.location.hostname + ':1337';
        var socket = io.connect("http://localhost:1337");

        socket.on('message', function(data) {
            if (data.offer) {
                peer.setRemoteDescription(new RTCSessionDescription(data.offer));

                peer.createAnswer(function(answerSDP) {
                    peer.setLocalDescription(answerSDP);
                    console.log('Sending answer');
                    socket.emit('message', { answer: answerSDP });
                });

                peer.onaddstream = function (event) {
                    console.log("Got stream");
                    video.src = window.URL.createObjectURL(event.stream);
                };

                peer.onicecandidate = function (event) {
                    if (event.candidate) {
                        console.log('Sending ICE candidate');
                        socket.emit('message', { candidate : event.candidate, sender: 'monitor' });
                    }
                }
            }
            else if (data.candidate && data.sender != 'monitor') {
                console.log('Received ICE candidate');
                console.log(data.candidate);

                peer.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });


        function iceServerConfig() {
            var isChrome = !!navigator.webkitGetUserMedia;
            var STUN = {
                url: isChrome
                        ? 'stun:stun.l.google.com:19302'
                        : 'stun:23.21.150.121'
            };

            var TURN = {
                url: 'turn:homeo@turn.bistri.com:80',
                credential: 'homeo'
            };

            return {
                iceServers: [STUN, TURN]
            };
        }

    </script>
</html>