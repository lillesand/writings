<!DOCTYPE html>
<html>

<body>
<video autoplay></video>
<button>Send!</button>
</body>


<script src="signalling/lib/socket.io.js"></script>
<script src="../lib/webrtc-adapter.js"></script>

<script type="application/javascript">

    var video = document.querySelector('video'),
            button = document.querySelector('button');

    var socketUrl = window.location.hostname + ":1337";
    var socket = io.connect(socketUrl);

    var peer = new RTCPeerConnection(iceServerConfig(), []);

    navigator.getUserMedia({video: true, audio: false}, function (stream) {
        video.src = window.URL.createObjectURL(stream);

        button.addEventListener('click', function() {
            createOffer(stream);
        });
    });

    socket.on('message', function(data) {
        if (data.answer) {
            console.log('Received answer');
            peer.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
        else if (data.candidate && data.sender != 'camera') {
            console.log('Received ICE candidate');
            console.log(data.candidate);

            peer.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });

    peer.onicecandidate = function (event) {
        if (event.candidate) {
            console.log('Sending ICE candidate');
            socket.emit('message', { candidate : event.candidate, sender: 'camera' });
        }
    };

    function createOffer(offerStream) {
        peer.addStream(offerStream);

        peer.createOffer(function(offerSDP) {
            peer.setLocalDescription(offerSDP);

            console.log('Sending offer');
            socket.emit('message', {offer: offerSDP});
        });
    }


    function iceServerConfig() {
        var isChrome = !!navigator.webkitGetUserMedia;
        var STUN = {
            url: isChrome
                    ? 'stun:stun.l.google.com:19302'
                    : 'stun:23.21.150.121'
        };

        var TURN = {
            url: 'turn:homeo@turn.bistri.com:80',
            username: 'homeo',
            credential: 'homeo'
        };

        return {
            iceServers: [STUN, TURN]
        };
    }
</script>
</html>