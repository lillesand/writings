<!DOCTYPE html>
<html>
    <head>
        <script src="http://localhost:1337/socket.io/socket.io.js"></script>
    </head>

    <body>
        <video autoplay></video>
        <canvas></canvas>
        <div></div>
    </body>

    <script type="application/javascript">
        var video = document.querySelector('video'),
                canvas = document.querySelector('canvas');

        navigator.getMedia = ( navigator.getUserMedia ||
                navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia ||
                navigator.msGetUserMedia);

        navigator.getMedia({video:true, audio: false},
            function(stream) {
                video.src = window.URL.createObjectURL(stream);
            });

        createOffer();

        function createOffer() {
            var sdpConstraints = {
                optional: [],
                mandatory: {
                    OfferToReceiveAudio: true,
                    OfferToReceiveVideo: true
                }
            };

            var isChrome = !!navigator.webkitGetUserMedia;

            // Session Traversal Utilities for NAT
            var STUN = {
                url: isChrome
                        ? 'stun:stun.l.google.com:19302'
                        : 'stun:23.21.150.121'
            };

            var TURN = {
                url: 'turn:homeo@turn.bistri.com:80',
                credential: 'homeo'
            };

            var iceServers = {
                iceServers: [STUN, TURN]
            };

            var DtlsSrtpKeyAgreement = {
                DtlsSrtpKeyAgreement: true
            };

            var optional = {
                optional: [DtlsSrtpKeyAgreement]
            };

            var webSocket = new WebSocket('ws://localhost:3001');
            webSocket.onopen = function() {};
            webSocket.onmessage = function() {};

            var peer = new webkitRTCPeerConnection(iceServers, optional);
            peer.createOffer(function(offerSDP) {
                peer.setLocalDescription(offerSDP);
                console.log(offerSDP);

                webSocket.send({
                    targetUser: 'joran',
                    offerSDP: offerSDP
                })
            }, function(error) {alert('s√∏der, feila'); console.warn(error)}, sdpConstraints);
        }
    </script>
</html>